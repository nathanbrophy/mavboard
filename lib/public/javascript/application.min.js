/*! mavboard - v0.0.0 - 2019-05-06 */
var trackNum=0;function generateList(){window.music.mopidy.tracklist.getTracks().then(t=>{var e=document.getElementById("spotify-interative-list-container").querySelector("ul");e.innerHTML="";for(var a=0;a<t.length;a++){new interactiveListItem(t[a]).appendToContainer(e)}})}function volumeChanged(t){window.music.mopidy.mixer.setVolume(parseInt(t.value))}function toggleMute(t){"volume-down"==t.id?(document.getElementById("volume-mute").style.display="block",t.style.display="none",document.getElementById("music-volume-control").disabled=!0,window.music.mopidy.mixer.setMute(!0)):(document.getElementById("volume-down").style.display="block",t.style.display="none",document.getElementById("music-volume-control").disabled=!1,window.music.mopidy.mixer.setMute(!1))}function toggleConsume(t){window.music.mopidy.tracklist.getConsume().then(t=>window.music.mopidy.tracklist.setConsume(!t))}function ilistDrag(t){t.dataTransfer.setData("text",t.target.id)}function ilistDropDelete(t){t.preventDefault();var e=t.dataTransfer.getData("text"),a=document.getElementById(e),n=a.querySelector(".ilist-track-uri").innerHTML;window.music.mopidy.tracklist.remove({uri:[n]}),a.remove()}function ilistAllowDrop(t){t.preventDefault()}var currentTime,totalTime,paused,intervalfn,interactiveListItem=function(t){trackNum++;var e=t.length,a=parseInt(e/6e4);e-=6e4*a;var n=parseInt(e/1e3);n<10&&(n="0"+n),this.trackName=t.name,this.trackLength=`${a}:${n}`,this.album=t.album.name,this.artist=t.artists[0].name,this.uri=t.uri};function searchSpotify(t){t.preventDefault();var e=document.getElementById("search-results-list"),a=document.getElementById("query").value;window.music.mopidy.library.search({any:a}).then(t=>{for(var a,n=0;n<t.length;n++)t[n].tracks&&(a=t[n]);var i=a.tracks;e.innerHTML="";for(n=0;n<i.length;n++){var r=i[n],s=document.createElement("li");s.classList.add("interactive-track-item"),s.innerHTML=`<div class="ilist-row0 search-result">\n\t\t\t\t\t\t\t\t<p class="ilist-track-name">${r.name}</p>\n\t\t\t\t\t\t\t  \t<p class="ilist-track-uri" style="display:none;" id='uri?${n}'>${r.uri}</p>\n\t\t\t\t\t\t\t  \t<a class='search-item-options' id='play?${n}' onclick='playTrack(this, false)'>Play</a>\n\t\t\t\t\t\t\t  \t<a class='search-item-options' id='playnext?${n}' onclick='playTrack(this, true)'>Play Next</a>\n\t\t\t\t\t\t\t  \t<a class='search-item-options' id='addqueue?${n}' onclick='addTrackToQueue(this)'>Add to Queue</a>\n\t\t\t\t\t\t\t  \t<a class='search-item-options' id='copyuri?${n}' onclick='copyTrackURI(this)'>Copy URI</a>\n\t\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t\t  <div class="ilist-row1 search-result">\n\t\t\t\t\t\t\t\t  <p class="ilist-track-artist">${r.artists[0].name}</p>\n\t\t\t\t\t\t\t\t  <p>|</p>\n\t\t\t\t\t\t\t\t  <p class="ilist-track-album">${r.album.name}</p>\n\t\t\t\t\t\t\t  </div>`,s.id="track-list-item-"+n,e.appendChild(s)}})}function playTrack(t,e){var a=t.id,n=e?a.replace("playnext","uri"):a.replace("play","uri"),i=document.getElementById(n).innerHTML;window.music.mopidy.tracklist.getLength().then(t=>{var a=1;t<1&&(a=0),window.music.mopidy.tracklist.add(null,a,i),e||(console.log(window.music.mopidy),1==a&&window.music.mopidy.playback.next(),window.music.mopidy.playback.play())})}function addTrackToQueue(t){var e=t.id.replace("addqueue","uri"),a=document.getElementById(e).innerHTML;window.music.mopidy.tracklist.getLength().then(t=>{window.music.mopidy.tracklist.add(null,t,a)})}function copyTrackURI(t){var e=t.id.replace("copyuri","uri"),a=document.getElementById(e).innerHTML,n=document.getElementById("copy-to-ckipboard");n.value=a,n.select(),document.execCommand("copy")}interactiveListItem.prototype.appendToContainer=function(t){var e=document.createElement("li");e.classList.add("interactive-track-item"),e.innerHTML=`<div class="ilist-row0">\n\t\t\t\t\t\t<p class="ilist-track-name">${this.trackName}</p>\n\t\t\t\t\t  \t<p class="ilist-track-length">${this.trackLength}</p>\n\t\t\t\t\t  \t<p class="ilist-track-uri" style="display:none;">${this.uri}</p>\n\t\t\t\t\t  </div>\n\t\t\t\t\t  <div class="ilist-row1">\n\t\t\t\t\t\t  <p class="ilist-track-artist">${this.artist}</p>\n\t\t\t\t\t\t  <p>|</p>\n\t\t\t\t\t\t  <p class="ilist-track-album">${this.album}</p>\n\t\t\t\t\t  </div>`,e.draggable=!0,e.ondragstart=ilistDrag,e.id=`interactive-track-item-${trackNum}`,t.appendChild(e)};var xmlH=new XMLHttpRequest;xmlH.onreadystatechange=function(){if(4==xmlH.readyState&&200==xmlH.status){var t=JSON.parse(xmlH.responseText);currentTime=parseInt(t.curr),totalTime=parseInt(t.total),updateTimeBar(),intervalfn=setInterval(function(){paused||(currentTime++,updateTimeBar())},1e3)}},xmlH.open("GET","/currentTime",!0),xmlH.send();class SpotifyController{constructor(){this.rpcURL="http://192.168.140.99:6680/mopidy/rpc",this.wsURL="ws://192.168.140.99:6680/mopidy/ws",this.initMopidy().then(t=>{this.mopidy=t;const e=new Event("spotifyready"),a=document.querySelector(".spotify");a?a.dispatchEvent(e):console.error("Unable to bind to mopdiy div")}),this.state={online:!1,currentTrack:{},nextTracks:{},previousTrack:{}}}initMopidy(){return new Promise((t,e)=>{const a=new Mopidy({autoConnect:!0,webSocketUrl:this.wsURL});a.on(this.syncState);try{a.on("state:online",()=>{if(this.state.online=!0,!window.playlist){a.tracklist.setConsume(!0);var e=document.getElementById("consume-toggle");e&&!e.classList.contains("on")&&e.classList.add("on");var n=document.getElementById("music-volume-control").value;a.mixer.setVolume(parseInt(n)),a.playback.getCurrentTrack().then(t=>{this.state.currentTrack=t,this.state.currentTrack?(console.log(`Currently playing ${this.state.currentTrack.name} by ${this.state.currentTrack.artists[0].name}`),a.library.getImages([t.uri]).then(e=>updateCoverArt(t.uri,e))):a.playlists.getPlaylists().then(function(t){var e;console.log("Loading playlist");for(var n=0;n<t.length;n++)"MSP Fall 2018"==t[n].name&&(e=t[n]);if(null!=e){for(var i,r,s=e.tracks.length;0!=s;)r=Math.floor(Math.random()*s),s-=1,i=e.tracks[s],e.tracks[s]=e.tracks[r],e.tracks[r]=i;a.tracklist.add(e.tracks).then(function(t){a.playback.play(t[0]).then(function(){console.log("Loaded the playlist.")})})}}).done()}),a.playback.getCurrentTrack().then(t=>{this.state.currentTrack=t,this.state.currentTrack?(console.log(`Currently playing ${this.state.currentTrack.name} by ${this.state.currentTrack.artists[0].name}`),document.getElementById("currSong").innerHTML=t.name+" -- "+t.artists[0].name,a.library.getImages([t.uri]).then(e=>updateCoverArt(t.uri,e))):console.log("No track currently playing")})}t(a)})}catch(t){e(t)}})}sptPlay(){this.state.online&&this.mopidy.playback.play()}sptPause(){this.state.online&&this.mopidy.playback.pause()}sptPreviousTrack(){this.state.online&&this.mopidy.playback.previous()}sptNextTrack(){this.state.online&&this.mopidy.playback.next()}syncState(t){switch(console.log("event: ",t),t){case"state:online":window.music.state.online=!0;break;case"state:offline":case"reconnectionPending":case"reconnecting":window.music.state.online=!1;break;case"event:trackPlaybackStarted":window.music.mopidy.playback.getCurrentTrack().then(t=>{window.music.state.currentTrack=t,console.log("currently playling: ",t),intervalfn&&clearInterval(intervalfn),totalTime=parseInt(t.length/1e3),currentTime=0,updateTimeBar(),intervalfn=setInterval(function(){paused||(currentTime++,updateTimeBar())},1e3),document.getElementById("currSong").innerHTML=t.name+" -- "+t.artists[0].name,window.music.mopidy.library.getImages([t.uri]).then(e=>updateCoverArt(t.uri,e))});break;case"event:trackPlaybackResumed":paused=!1;break;case"event:trackPlaybackPaused":paused=!0;break;case"event:volumeChanged":console.log("Volume changed");break;case"event:tracklistChanged":console.log("");break;case"event:optionsChanged":window.music.mopidy.tracklist.getConsume().then(t=>{t?(document.getElementById("consume-toggle").classList.remove("off"),document.getElementById("consume-toggle").classList.add("on")):(document.getElementById("consume-toggle").classList.remove("on"),document.getElementById("consume-toggle").classList.add("off"))})}}}window.music=new SpotifyController,console.log(window.music);var prevTrackImages=[];const MAX_PREV_IMAGES=2;function updateCoverArt(t,e){const[a]=e[t];var n=document.getElementById("current-track-image");n.src&&n.src!=a.uri&&(prevTrackImages.length==MAX_PREV_IMAGES&&prevTrackImages.pop(),prevTrackImages.unshift({src:n.src,height:n.height,width:n.width}));for(var i=0;i<prevTrackImages.length;i++){var r=document.getElementById("prev-track-image-"+(i+1));r.setAttribute("src",prevTrackImages[i].src);var s=(100-10*(i+1))/100,c=prevTrackImages[i].height*s,o=prevTrackImages[i].width*s,l=0==i?-31:-35,m=(n.height-c)/2;m+="px ",r.setAttribute("height",c+"px"),r.setAttribute("width",o+"px"),r.style.margin=m+"0 "+m+l+"%"}n.setAttribute("src",a.uri),n.setAttribute("height",a.height+"px"),n.setAttribute("width",a.width+"px")}function updateTimeBar(){if(!(currentTime>totalTime)){var t,e=currentTime,a=parseInt(e/60),n=e=e-60*a;n<=9&&(n="0"+n),t=`${a}:${n}`,document.getElementById("current-time").innerHTML=t;var i;e=totalTime,(n=e-=60*(a=parseInt(e/60)))<=9&&(n="0"+n),i=`${a}:${n}`,document.getElementById("total-time").innerHTML=i;var r=currentTime/totalTime*100;document.getElementById("time-bar").style.width=r+"%"}}